name: microfrontend-deployment

on:
    push:
        branches: [ main ]
        paths:
            - "web/**"

defaults:
    run:
        working-directory: .

jobs:
    build:
        runs-on: ubuntu-latest

        steps:

            - name: checkout action
              uses: actions/checkout@v3

            - name: install node.JS
              uses: actions/setup-node@v2
              with:
                node-version: "16"

            - name: install dependencies
              run: yarn

            - name: generate microfrontend builds
              run: yarn nx build shared && yarn nx build container

            - name: install and configure aws-cli
              uses: aws-actions/configure-aws-credentials@master
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
                aws-region: "us-west-1"

            - name: synth and deploy stack
              run: yarn cdk synth && yarn cdk deploy --all --require-approval never